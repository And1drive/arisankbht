<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Arisan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0ea5a4">
</head>
<body class="bg-gradient-to-br from-sky-50 to-cyan-50 min-h-screen font-sans text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 bg-teal-500 rounded-lg flex items-center justify-center text-white text-2xl font-bold">AA</div>
        <div>
          <h1 class="text-2xl font-extrabold">Aplikasi Arisan</h1>
          <p class="text-sm text-slate-600">Manajemen arisan — akses dari browser</p>
        </div>
      </div>
      <div id="userInfo" class="hidden items-center gap-3">
        <span id="userName" class="text-sm"></span>
        <button id="btnLogout" class="px-3 py-1 bg-red-500 text-white rounded">Logout</button>
      </div>
    </header>

    <main class="bg-white/80 shadow-lg rounded-xl p-6">
      <!-- LOGIN -->
      <div id="loginCard" class="max-w-md mx-auto">
        <h2 class="text-xl font-semibold mb-4">Login</h2>
        <div class="space-y-3">
          <input id="inpUser" placeholder="Username" class="w-full p-3 border rounded" />
          <input id="inpPass" type="password" placeholder="Password" class="w-full p-3 border rounded" />
          <div class="flex items-center justify-between">
            <button id="btnLogin" class="px-4 py-2 bg-teal-500 text-white rounded">Masuk</button>
            <small class="text-slate-500">Hubungi admin untuk akses</small>
          </div>
        </div>
      </div>

      <!-- APP -->
      <div id="app" class="hidden">
        <div id="mainMenu" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <button class="card p-6 rounded-lg shadow hover:shadow-lg bg-white flex flex-col items-start" data-menu="input">
            <h3 class="text-lg font-bold">Input Data</h3>
            <p class="text-sm text-slate-500">Masukkan setoran arisan</p>
          </button>
          <button class="card p-6 rounded-lg shadow hover:shadow-lg bg-white flex flex-col items-start" data-menu="pengeluaran">
            <h3 class="text-lg font-bold">Pengeluaran</h3>
            <p class="text-sm text-slate-500">Catat pengeluaran panitia</p>
          </button>
          <button class="card p-6 rounded-lg shadow hover:shadow-lg bg-white flex flex-col items-start" data-menu="laporan">
            <h3 class="text-lg font-bold">Laporan</h3>
            <p class="text-sm text-slate-500">Laporan arisan, kas panitia & pengeluaran</p>
          </button>
        </div>

        <!-- Page: Input -->
        <section id="pageInput" class="hidden">
          <div class="flex gap-6">
            <div class="w-1/3 bg-slate-50 p-4 rounded">
              <label class="block text-sm mb-1">Penerima</label>
              <select id="selPenerima" class="w-full p-2 border rounded"></select>
              <label class="block text-sm mt-3 mb-1">Bulan</label>
              <select id="selBulan" class="w-full p-2 border rounded"></select>
              <label class="block text-sm mt-3 mb-1">Tahun</label>
              <select id="selTahun" class="w-full p-2 border rounded"></select>
            </div>

            <div class="flex-1 bg-slate-50 p-4 rounded">
              <label class="block text-sm mb-1">Penyetor</label>
              <select id="selPenyetor" class="w-full p-2 border rounded"></select>

              <label class="block text-sm mt-3 mb-1">Jumlah Disetor</label>
              <input id="inpJumlah" class="w-full p-2 border rounded" inputmode="numeric" />

              <label class="block text-sm mt-3 mb-1">Kas Untuk Penerima</label>
              <input id="inpKasPenerima" class="w-full p-2 border rounded" inputmode="numeric" />

              <label class="block text-sm mt-3 mb-1">Kas Untuk Panitia</label>
              <input id="inpKasPanitia" class="w-full p-2 border rounded" inputmode="numeric" />

              <div class="flex gap-3 mt-4">
                <button id="btnSaveInput" class="px-4 py-2 bg-teal-600 text-white rounded">Simpan</button>
                <button id="btnBackFromInput" class="px-4 py-2 bg-slate-200 rounded">Kembali</button>
                <span id="saveMsgInput" class="ml-3 text-teal-600 hidden">✔ Data berhasil disimpan</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Page: Pengeluaran -->
        <section id="pagePengeluaran" class="hidden">
          <div class="max-w-2xl">
            <label class="block text-sm mb-1">Tanggal</label>
            <input id="inpTanggalPengeluaran" type="date" class="w-full p-2 border rounded" />
            <label class="block text-sm mt-3 mb-1">Keterangan</label>
            <input id="inpKeteranganPengeluaran" class="w-full p-2 border rounded" />
            <label class="block text-sm mt-3 mb-1">Nominal</label>
            <input id="inpNominalPengeluaran" class="w-full p-2 border rounded" inputmode="numeric" />
            <div class="flex gap-3 mt-4">
              <button id="btnSavePengeluaran" class="px-4 py-2 bg-teal-600 text-white rounded">Simpan</button>
              <button id="btnBackFromPengeluaran" class="px-4 py-2 bg-slate-200 rounded">Kembali</button>
              <span id="saveMsgPengeluaran" class="ml-3 text-teal-600 hidden">✔ Data berhasil disimpan</span>
            </div>
          </div>
        </section>

        <!-- Page: Laporan -->
        <section id="pageLaporan" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <button class="p-4 bg-white rounded shadow" data-report="arisan">Laporan Arisan</button>
            <button class="p-4 bg-white rounded shadow" data-report="kas">Laporan Kas Untuk Panitia</button>
            <button class="p-4 bg-white rounded shadow" data-report="pengeluaran">Laporan Pengeluaran</button>
          </div>
          <div id="reportArea" class="bg-white p-4 rounded shadow min-h-[200px]"></div>
          <div class="mt-4"><button id="btnBackFromLaporan" class="px-4 py-2 bg-slate-200 rounded">Kembali</button></div>
        </section>

        <!-- Admin modal -->
        <div id="adminPanel" class="hidden fixed inset-0 bg-black/40 items-center justify-center">
          <div class="bg-white p-6 rounded shadow max-w-2xl w-full">
            <h3 class="text-lg font-bold mb-3">Admin - Kelola User</h3>
            <div class="mb-3">
              <label class="block text-sm">Username</label>
              <input id="adm_username" class="w-full p-2 border rounded" />
              <label class="block text-sm mt-2">Password</label>
              <input id="adm_password" class="w-full p-2 border rounded" />
              <div class="flex gap-2 mt-2">
                <label class="inline-flex items-center"><input id="perm_open" type="checkbox" class="mr-2"/> Open</label>
                <label class="inline-flex items-center"><input id="perm_insert" type="checkbox" class="mr-2"/> Insert</label>
                <label class="inline-flex items-center"><input id="perm_update" type="checkbox" class="mr-2"/> Update</label>
                <label class="inline-flex items-center"><input id="perm_delete" type="checkbox" class="mr-2"/> Delete</label>
              </div>
              <div class="flex gap-2 mt-4">
                <button id="admSave" class="px-3 py-2 bg-teal-600 text-white rounded">Simpan User</button>
                <button id="admClose" class="px-3 py-2 bg-slate-200 rounded">Tutup</button>
              </div>
            </div>
            <div>
              <h4 class="font-semibold mb-2">Daftar User</h4>
              <div id="userList" class="space-y-2 max-h-40 overflow-auto"></div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <footer class="text-center text-sm text-slate-500 mt-6">&copy; 2025 Aplikasi Arisan</footer>
  </div>

<script>
// === CONFIG - GANTI dengan URL Web App Google Apps Script anda ===
const GAS_WEB_APP = 'https://script.google.com/macros/s/AKfycbzK-CUQ4Zk_Dw4y5kPrQKmZXJ4J8r05v5mM857o53h2vYQPBbsozfir5ZJBORtzP55f1g/exec'; // <-- GANTI

// helper: format rupiah
const formatRupiah = (v) => {
  const n = Number(String(v).replace(/[^0-9\-]/g,'')) || 0;
  return new Intl.NumberFormat('id-ID').format(n);
}

// API wrapper
async function api(path, data=null){
  const url = GAS_WEB_APP + path;
  const opts = { method: data ? 'POST' : 'GET', headers: { 'Content-Type':'application/json' } };
  if (data) opts.body = JSON.stringify(data);
  const res = await fetch(url, opts);
  return res.json();
}

// State
let currentUser = null, masterNames = [];

// DOM refs & UI logic
const loginCard = document.getElementById('loginCard');
const app = document.getElementById('app');
const userInfo = document.getElementById('userInfo');
const userName = document.getElementById('userName');
const btnLogout = document.getElementById('btnLogout');

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const u = document.getElementById('inpUser').value.trim();
  const p = document.getElementById('inpPass').value;
  if(!u||!p) return alert('Isi username & password');
  try{
    const r = await api('/login', { username: u, password: p });
    if (r.success){
      currentUser = r.user;
      localStorage.setItem('arisan_token', r.token);
      showApp();
      await loadMasterData();
      if (currentUser.isAdmin) showAdminButton();
    } else alert(r.message || 'Login gagal');
  }catch(err){ alert('Gagal terhubung ke server: '+err.message); }
});

btnLogout.addEventListener('click', ()=>{ localStorage.removeItem('arisan_token'); currentUser=null; showLogin(); });

function showLogin(){ loginCard.classList.remove('hidden'); app.classList.add('hidden'); userInfo.classList.add('hidden'); }
function showApp(){ loginCard.classList.add('hidden'); app.classList.remove('hidden'); userInfo.classList.remove('hidden'); userName.textContent = currentUser.username + (currentUser.isAdmin? ' (Admin)': ''); }

document.querySelectorAll('[data-menu]').forEach(btn=>btn.addEventListener('click', e=> openMenu(e.currentTarget.dataset.menu)));
function openMenu(name){
  document.getElementById('pageInput').classList.add('hidden');
  document.getElementById('pagePengeluaran').classList.add('hidden');
  document.getElementById('pageLaporan').classList.add('hidden');
  document.getElementById('reportArea').innerHTML = '';
  if (name==='input') document.getElementById('pageInput').classList.remove('hidden');
  if (name==='pengeluaran') document.getElementById('pagePengeluaran').classList.remove('hidden');
  if (name==='laporan') document.getElementById('pageLaporan').classList.remove('hidden');
}

document.getElementById('btnBackFromInput').addEventListener('click', ()=> document.getElementById('pageInput').classList.add('hidden'));
document.getElementById('btnBackFromPengeluaran').addEventListener('click', ()=> document.getElementById('pagePengeluaran').classList.add('hidden'));
document.getElementById('btnBackFromLaporan').addEventListener('click', ()=> document.getElementById('pageLaporan').classList.add('hidden'));

['inpJumlah','inpKasPenerima','inpKasPanitia','inpNominalPengeluaran'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('blur', ()=> el.value = formatRupiah(el.value));
});

// Save Input
document.getElementById('btnSaveInput').addEventListener('click', async ()=>{
  if(!currentUser) return alert('Login dulu');
  const payload = {
    penerima: document.getElementById('selPenerima').value,
    bulan: document.getElementById('selBulan').value,
    tahun: document.getElementById('selTahun').value,
    penyetor: document.getElementById('selPenyetor').value,
    jumlah: Number(String(document.getElementById('inpJumlah').value).replace(/\D/g,''))||0,
    kasPenerima: Number(String(document.getElementById('inpKasPenerima').value).replace(/\D/g,''))||0,
    kasPanitia: Number(String(document.getElementById('inpKasPanitia').value).replace(/\D/g,''))||0,
    token: localStorage.getItem('arisan_token')
  };
  const res = await api('/saveInput', payload);
  if (res.success){ const msg = document.getElementById('saveMsgInput'); msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),2000); }
  else alert(res.message||'Gagal simpan');
});

// Save Pengeluaran
document.getElementById('btnSavePengeluaran').addEventListener('click', async ()=>{
  const payload = {
    tanggal: document.getElementById('inpTanggalPengeluaran').value,
    ket: document.getElementById('inpKeteranganPengeluaran').value,
    nominal: Number(String(document.getElementById('inpNominalPengeluaran').value).replace(/\D/g,''))||0,
    token: localStorage.getItem('arisan_token')
  };
  const res = await api('/savePengeluaran', payload);
  if (res.success){ const msg = document.getElementById('saveMsgPengeluaran'); msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'),2000); }
  else alert(res.message||'Gagal simpan');
});

// Reports (arisan, kas, pengeluaran) - functions omitted here for brevity but included in full package
// For brevity in this message, full report functions are implemented like earlier: showReportArisan, showReportKas, showReportPengeluaran
// ... (they call API endpoints /reportArisan, /reportKas, /getPengeluaran) ...

// Load master data
async function loadMasterData(){
  try{
    const res = await api('/masterNames');
    if (res.success){
      masterNames = res.data || [];
      const sel = document.getElementById('selPenerima');
      const sel2 = document.getElementById('selPenyetor');
      if(sel) sel.innerHTML = masterNames.map(n=>`<option>${n}</option>`).join('');
      if(sel2) sel2.innerHTML = sel.innerHTML;
      const now = new Date();
      const monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      if(document.getElementById('selBulan')) document.getElementById('selBulan').innerHTML = monthNames.map((m,i)=>`<option value="${i+1}" ${i===now.getMonth()? 'selected':''}>${m}</option>`).join('');
      if(document.getElementById('selTahun')) document.getElementById('selTahun').innerHTML = Array.from({length:6},(_,i)=>now.getFullYear()-2+i).map(y=>`<option ${y===now.getFullYear()?'selected':''}>${y}</option>`).join('');
    } else alert('Gagal ambil master data');
  }catch(err){ alert('Gagal ambil master data: '+err.message); }
}

// Admin helpers (getUsers/saveUser/deleteUser) implemented similarly; omitted here for compactness

// try restore session
(async function(){
  const tok = localStorage.getItem('arisan_token');
  if (tok){
    try{
      const r = await api('/whoami', { token: tok });
      if (r.success){ currentUser = r.user; showApp(); await loadMasterData(); if (currentUser.isAdmin) showAdminButton(); }
      else showLogin();
    }catch(e){ showLogin(); }
  } else showLogin();
})();
</script>
</body>
</html>

